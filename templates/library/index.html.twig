{% extends 'base.html.twig' %}
{% block title %}Библиотека{% endblock %}
{% block body %}
    <div class="second-wrapper">
        <div id="modalContainer"></div>
        <div>
            <button type="button" onclick="loadModalWindow('{{ path('library_add_book') }}')" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bookAddModalWindow">Добавить</button>  
            <button id="libraryDeleteBookButton" type="button" onclick="libraryBookDeleteMode()" class="btn btn-primary">Удалить</button>
            <button id="libraryDeleteModeButton" type="button" onclick="libraryBookDeleteMode()" class="btn btn-primary">Удалить</button>  
        </div>
        <table  id="myTable" class="table table-striped table-bordered table-hover">
            <thead>
                <th>Наименование</th>
                <th>Автор</th>
                <th>Начал</th>
                <th>Закончил</th>
                <th>Статус</th>
                <th>Оценка</th>
                <th>Скачать</th>
            </thead>
            <tbody>
                {% for book in books %}
                    <tr id="book{{book.id}}" onclick="loadModalWindow('{{ path('library_view_book', {'id': book.id}) }}')">
                        <td>{{book.name}}</td>
                        <td>{{book.author == null ? '---' : book.author}}</td>
                        <td>{{book.startAt == null ? '---' : book.startAt|date('d-m-Y')}}</td>
                        <td>{{book.endAt == null ? '---' : book.endAt|date('d-m-Y')}}</td>
                        <td>{{book.status}}</td>
                        <td>{{book.score}}</td>
                        {% if book.source == null %}
                            <td>
                                <button type=""><input type="file" id="upload-photo" style="display: none"></button>
                            </td>
                        {% else %} 
                            <td>
                                <button>Скачать</button>
                            </td>
                        {% endif %}    
                    </tr>
                {% endfor %}    
            </tbody>
        </table>
    </div>
    <div class="context-menu">
        <ul>
            <li id="deleteOption">Удалить</li>
            <!-- Другие опции контекстного меню могут быть добавлены здесь -->
        </ul>
    </div>
{% endblock %}
{% block javascripts %}
    {{parent()}}
    <script>
        $(document).ready(function(){
        // Показываем контекстное меню при нажатии ПКМ на строку
        $("tr").on("contextmenu", function(event) {
        event.preventDefault(); // Предотвращаем появление стандартного контекстного меню браузера
        $(this).find("input[type='checkbox']").prop('checked', true); // Выбираем текущую строку
        
        // Позиционируем контекстное меню рядом с указателем мыши
        $(".context-menu").css({
            top: event.pageY,
            left: event.pageX
        }).show();
        
        // Обработчик события нажатия на пункт "Удалить" контекстного меню
        $(".context-menu #deleteOption").click(function(){
            $(this).closest("tr").remove(); // Удаляем текущую строку таблицы
            $(".context-menu").hide(); // Скрываем контекстное меню после удаления
        });
    });
    
    // Скрываем контекстное меню при клике где-либо за его пределами
    $(document).on("click", function(){
        $(".context-menu").hide();
    });
});
        function libraryBookDeleteMode()
        {
            
            console.log('IN PROGRESS');
        }
        function loadModalWindow(url)
        {
            if (typeof fetchingInProgress !== 'undefined' && fetchingInProgress) {
                        console.log('Запрос все еще выполняется, подождите завершения');
                        return; // Прерываем выполнение функции, если запрос все еще выполняется
                }
            fetchingInProgress = true;    
            if (!document.getElementById(url)) 
            {
                
                fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
                })
                .then(response => response.text())
                .then(data => {
                    fetchingInProgress = false;
                    let dataWithoutScripts = $(data).not('script').prop('outerHTML');
                    document.getElementById('modalContainer').insertAdjacentHTML('beforeend', dataWithoutScripts);
                    $('#'+url.replace(/\//g, "\\/")).modal('show');
                    let scripts = $(data).filter('script');
                    scripts.each(function() 
                    {
                        $('body').append($(this).prop('outerHTML'));
                    });
                })
                .catch(error => {
                    fetchingInProgress = false;
                    });
            }
            else 
            {
                $('#'+url.replace(/\//g, "\\/")).modal('toggle');
            }
        }
    </script>
{% endblock %}